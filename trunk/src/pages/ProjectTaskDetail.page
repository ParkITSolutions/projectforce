<apex:page id="ProjectTaskDetail" standardController="ProjectTask__c" extensions="ProjectTaskDetailController"  sidebar="false" tabStyle="Project2__c">
    <!-- Ajax Toolkit SDFC -->
    <apex:includeScript value="/soap/ajax/11.1/connection.js"/>
    
    <apex:includeScript value="{!URLFOR($Resource.ProjectResources, 'inc/js/common.js')}"/>
    
    <!-- Script.aculo.us / Prototype -->
    <apex:includeScript value="{!URLFOR($Resource.Script_aculo_us, 'prototype.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.Script_aculo_us, 'scriptaculous.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.Script_aculo_us, 'effects.js')}"/>
    
     <!-- overlays resources -->
    <apex:includeScript value="{!URLFOR($Resource.overlaysResources, 'inc/js/js.js')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.overlaysResources, 'inc/css/css.css')}"/>
    
    <apex:stylesheet value="{!URLFOR($Resource.ProjectResources, 'inc/css/commonLayout.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ProjectResources, 'inc/css/projectLayout.css')}" />   
    <apex:stylesheet value="{!URLFOR($Resource.ProjectResources, 'inc/css/projectTaskDetail.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.commonResources, 'inc/css/fonts.css')}" />
    
    <!-- Portal Support -->
    <apex:includeScript value="{!$Resource.portalSupport}"/>
    
    <!-- CSS styles for Portal Integration -->
    <apex:stylesheet value="{!URLFOR($Resource.portalStyles, 'portal.css')}" />
    
    <!-- Common JS for All Sections -->

    <!-- CSS Includes -->
    <apex:stylesheet value="{!URLFOR($Resource.ProjectResources, 'inc/css/headerTeams.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ProjectResources, 'inc/css/teamDetails.css')}" />
    
    <!-- ProjectTaskDetail CSS -->
    <apex:stylesheet value="{!URLFOR($Resource.ProjectResources, 'inc/css/projectTaskDetails.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ProjectResources, 'inc/css/widgetTeam.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ProjectResources, 'inc/css/widgets/TeamMemberWidget.css')}" />   

    <!-- ProjectTaskList CSS -->
       <apex:stylesheet value="{!URLFOR($Resource.ProjectResources, 'inc/css/projectTaskList.css')}" />
                                                                    
    <!-- ProjectTaskDetail JS -->
    <apex:includeScript value="{!URLFOR($Resource.ProjectResources, 'inc/js/projectTaskDetail.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.ProjectResources, 'inc/js/projectTaskList.js')}" />
    
    <apex:form >
        <apex:actionFunction name="reloadIframe" action="{!dummyRefresh}" rerender="iframeWrapperPanel" />
    </apex:form>
    
    <script>
       document.observe("dom:loaded", function(){
               trunkAllTitles();
               //$$('.sidebar')[0].style.height =$$('.holder')[0].getDimensions().height + 15 + 'px';
               setTimeout( "readPortalCSSRules()", 300 );
               setTimeout( "$$('.pbBottomButtons')[0].remove()", 150);
                                                       
           }
       );
       
       var currentTeam = '{!Task.ProjectId}';
    </script>
    <script>
                function openAttachmentOverlay(){

                    newAttachmentFileOverlay.open(); 
                    newAttachmentToProject();
                    observeIframeUpload();
                    loadAttOverlay = true;
                    $('uploadIframe').src = $('uploadIframe').src;
                    addOverlayNewAttachmentEvents(function(){newAttachmentOverlay.close();},'UploadAttachment:Form:SaveButton');
                }
            </script>
    <style type = "text/css">
         div.swirly_overlay{
            height : 100%!important;
         }
        
    </style>
    

    <div class="confirmation" id="confirmation" style="display:none;">
           This task has been marked complete
    </div>
   
    <!-- Delete Task Overlay -->
    <c:ProjectDeleteTaskOverlay id="projectDeleteComponent"/>
    <c:ProjectOverlayDeleteAssignee id="projectDeleteAssigneeComponent"/>
    <c:ProjectOverlayDeleteAttachment id="ProjectOverlayDeleteAttachmentInclude" />
    
     <!-- Upload Attachment -->
    <c:ProjectOverlayNewAttachment parentId="{!Task.Id}" />
    <c:ApplicationTop id="ApplicationTop" />
   <c:PromptOverlay id="PromptOverlay"
        includeAttachment="true" 
        includeNewAssignee="true"
        includeNewMember="true"
	    idValue="{!projectId}"
   />                     
         
         
    <!-- includeNewMember="true" -->
    <!-- Header -->
    <apex:composition template="HeaderTemplate">
        <apex:define name="moduleId"><apex:variable var="moduleId" value="headerProject"/></apex:define>
        <apex:define name="module">{!$ObjectType.Project2__c.label}</apex:define>
        <apex:define name="title">{!Task.ProjectName}</apex:define>
        <apex:define name="search">
            <c:Search module="Project" projectId="{!Task.ProjectId}"/>
        </apex:define>
    </apex:composition>
   
    <!-- Main Content Div -->
    <!-- <div class="main_content_projectList" style="overflow:hidden"> -->
    <div class="main_content_projectList">
    
        <!-- BreadCrumb and buttons -->    
        <div align="center" class="breadCrumbAndButtons">
	    	<c:Breadcrum />

        
        <div class="buttons" style="{!IF(Task.IsTaskOwner,'width:340px;','')}">
            <apex:outputpanel rendered="{!OR(userPermissions.canManage, Task.IsTaskOwner, Task.assignToMe)}" layout="block">
                <!-- /apex/projectRedirect?sO=ProjectTask__c&attr=task&page=ProjectCreateNewTask&rR=NewProjectFormContainer&oC=true&eid={!Task.ProjectId}&task={!Task.id} -->
                <a class="blackbutton" href="/{!Task.id}/e?retURL=/{!Task.id}"><span>Edit Task</span></a>
                <apex:form id="quickMilestoneForm" styleclass="quickMilestoneForm" onsubmit="if(isCompleted){alert('The task percent is already completed.');return false}"  >   
                    <apex:actionStatus id="taskStatus">
                        <apex:facet name="start">
                            <a class="blackbutton" href="Javascript:;" >
                                <span>Completing...</span>
                            </a>
                        </apex:facet>
                        <apex:facet name="stop">   
                            <apex:outputPanel id="TaskPanel">       
                                <apex:commandLink action="{!markComplete}"                                                                                 
                                    rerender="TaskPanel"
                                    status="taskStatus"
                                    rendered="{!IF(Task.PercentCompleted == 100 || isTaskParent, false, true)}"
                                    styleClass="blackbutton completeButton"
                                    oncomplete="completed(); apexAFRefreshDetail()">
                                    <span>Mark Complete</span> 
                                </apex:commandLink>
                            </apex:outputPanel>
                        </apex:facet>
                    </apex:actionStatus>
                </apex:form>                   
                <apex:outputPanel rendered="{!OR(userPermissions.canManage, Task.IsTaskOwner)}">
                    <a class="blackbutton" href="Javascript:;" onclick="showDeleteEvent('{!Task.id}', 'Detail','{!Task.name}');">
                        <span>Delete</span>
                    </a>
                </apex:outputPanel>  
                <apex:outputPanel rendered="{!OR(userPermissions.canManage, Task.IsTaskOwner)}">
                    <a class="blackbutton" href="/apex/TaskPdfExport?id={!Task.id}">
                        <span>PDF Export</span>
                    </a>
                </apex:outputPanel>
            </apex:outputpanel>
          </div>
        </div>      

        <!-- Sidebar -->
        <div class="sidebar">
            <apex:outputPanel id="sidebarWidgets">
                <!-- Team members -->
               <c:MembersWidget idProject="{!projectId}"  id="MembersWidget" />
            </apex:outputPanel>
            <div class="clear"></div>
        </div>
        
        <c:ProjectOverlayNewAssignee id="ProjectOverlayNewAssignee"/>
        <!-- Holder -->     
        <div class="holder" style="overflow:hidden;clear:both;margin:0px;margin-left:200px;margin-bottom:0px;" id="holder">
            
            <apex:outputpanel rendered="{!IF(!detailsOk,true,false)}"  layout="block">
                <p>No Id given , no id to look for</p>
            </apex:outputpanel>
            <apex:outputpanel id="detailContainer" styleClass="projectTaskDetail" rendered="{!detailsOk}" layout="block" style="overflow:hidden; position:relative; clear:both;" >
            
                <div style="display: none;" id="sw_all" class="swirly_members"></div>
                <div style="display: none;" id="swirlyAttachment" class="swirly_members"></div>
                <div style="display: none;" id="sw_all2" class="swirly_members"></div>     
                             
                <!-- Method to refresh task detail -->
                <apex:form id="taskDetail" >               
                    <apex:detail subject="{!Task.Id}" relatedList="false"  title="false" />
                    <apex:actionFunction name="apexAFRefreshDetail" 
                        action="{!doRefresh}" 
                        rerender="detailContainer, taskDetail" 
                        oncomplete="clearTableDetail();$( 'sw_all' ).hide(); $( 'sw_all2' ).hide()"/>
                        
                     <apex:actionFunction name="detailListPanel" 
                        action="{!doRefresh}" 
                        rerender="detailListPanel" 
                        oncomplete="$('sw_o').hide(); $('sw_all2').hide();swirly.hide();"/>
                        
                     <apex:actionFunction name="RefreshTaskAssignedList" 
                        action="{!doRefresh}" 
                        rerender="detailListPanel" 
                        oncomplete="swirly.hide(); infoToUser.show();"/>
                        
                </apex:form>
               
                <div class="bPageBlock">
                
                <apex:outputpanel id="detailListPanel">
                    <table class="detailList">
                        <tbody>
                            <tr>
                                <td class="labelCol">
                                    Status
                                </td>
                                
                                <td class="dataCol">
                                    <span class="taskStatus" style="display:none;" id="">In Progress</span>
                                    <span class="taskPercent" id="completedPercentNumber">{!Task.PercentCompleted}%</span>
                                    <div class="proj_percent_complete_outline" id="completedTrack">
                                        <div class="proj_percent_complete_value" style="width: {!Task.PercentCompleted}%;" id="completedPercent"></div>
                                        <script>var isCompleted = {!IF(Task.PercentCompleted == 100, true, false)};</script>
                                    </div>
                                </td>
                                <td class="labelCol"></td>
                                <td class="dataCol"></td>           
                            </tr>             
                            <tr >
                                <td class="labelCol vTop">Files</td>
                                <td class="dataCol">
                                    
                                    <apex:outputPanel rendered="{!OR(userPermissions.canManage, Task.IsTaskOwner, Task.assignToMe)}">    
                                        
                                        <div class="DistincLink">
                                            <a href="Javascript:;" 
                                               onclick="promptOverlay.open(attachment);">
                                                <img src="{!URLFOR($Resource.ProjectResources, 'images/layout/icons/add.png')}" alt="Add Attachment" title="Add Attachment" />
                                                Add New Attachment
                                            </a>
                                        </div>
                                    </apex:outputPanel>
                                    <apex:form id="attachmentList">
                                        <apex:actionFunction name="reloadAttachmentList" rerender="attachmentList" />
                                        <apex:repeat value="{!Task.Files}" var="item" >
                                            <div class="height20px">
                                                <div id="AttachContent"> 
                                                    <img style="vertical-align:bottom;" src="{!URLFOR($Resource.FileTypeIcons, item.attachImage)}"/> &nbsp;
                                                    <a href="javascript:;" onclick="window.open('/servlet/servlet.FileDownload?file={!item.Id}')" >{!item.Name}</a>&nbsp;&nbsp;&nbsp;
                                                
                                                <apex:outputPanel styleClass="height20px" rendered="{!OR(userPermissions.canManage, Task.IsTaskOwner, Task.assignToMe)}"> 
                                    
                                                    <apex:outputLink styleclass="notassigned"
                                                        onClick="deleteAttachmentOverlay.open(); 
                                                                 $('ProjectTaskDetail:ProjectOverlayDeleteAttachmentInclude:projectOverlayDeleteAttachment:overlayForm2:idToDelete').value ='{!item.Id}';
                                                                 addOverlayEvents(function(){deleteAttachmentOverlay.close();},'ProjectTaskDetail:ProjectOverlayDeleteAttachmentInclude:projectOverlayDeleteAttachment:overlayForm2:DeleteAttachmentBtn');"
                                                        value="javascript:;">
                                                        
                                                        Delete
                                                    </apex:outputLink>  
                                                                                            
                                                </apex:outputPanel>
                                                </div>
                                            </div>
                                        </apex:repeat>
                                    </apex:form>
                                </td>       
                            </tr>
                            <tr>
                                <td class="labelCol vTop">
                                    Assigned To
                                </td>
                                <td class="dataCol">
                                    <apex:outputpanel rendered="{!AND(NOT(MaxAssignees), OR(userPermissions.canManage, Task.IsTaskOwner, Task.assignToMe))}">
                                        <div class="DistincLink">
                                            <apex:image id="assignToImage" value="{!URLFOR($Resource.ProjectResources, 'images/layout/icons/add.png')}"/>
                                            <apex:outputLink id="assignToLink"
                                                onClick="promptOverlay.open(newAssignee); newAssigneeOverlay.initialize()"
                                                value="javascript:;">
                                                    New assignee
                                            </apex:outputLink>
                                        </div>
                                    </apex:outputpanel>
                                    <apex:outputpanel rendered="{!Task.HasAsignee}" id="assList">
                                        <table class="assignedToTable">
                                            <apex:repeat value="{!Task.Asignee}" var="item">
                                                <tr>
                                                    <td>
                                                        <a href="/{!item.Id}">{!item.Name}</a>
                                                    </td>
                                                    <td class="percent">{!item.percent}%</td>
                                                    <td>
                                                        <apex:outputpanel rendered="{!AND(IF(Task.CantAssignees > 1, true, false), OR(userPermissions.canManage, Task.IsTaskOwner, Task.assignToMe))}">
                                                            <a class="notassigned" value="{!item.AssigneeId}" onclick="showDeleteAssigneeEvent('{!item.AssigneeId}')" href="javascript:;">Remove</a>
                                                        </apex:outputpanel>
                                                    </td>                                                 
                                                </tr>                                      
                                            </apex:repeat>
                                        </table>
                                    </apex:outputpanel>
                                    <apex:outputpanel rendered="{!IF(!Task.HasAsignee,true,false)}" >
                                        Nobody Asigned to this task.
                                    </apex:outputpanel>
                                </td>
                            </tr>
                            <tr>
                                <td class="labelCol vTop">Notes</td>
                                <td class="dataCol">
                                    <apex:outputpanel rendered="{!OR(userPermissions.canManage, Task.IsTaskOwner, Task.assignToMe)}">
                                        <div class="DistincLink">
                                            <a href="ProjectTaskNotes?id_task={!Task.id}">
                                                <img src="{!URLFOR($Resource.ProjectResources, 'images/layout/icons/task_edit.png')}" alt="Add assignee" title="Add assignee" />
                                                Edit Notes
                                            </a>
                                        </div>
                                    </apex:outputpanel>
                                    <apex:outputpanel rendered="{!NOT(OR(userPermissions.canManage, Task.IsTaskOwner, Task.assignToMe))}">
                                        <div class="DistincLink">
                                                Without permission to edit Notes
                                        </div>
                                    </apex:outputpanel>
                                </td>
                            </tr>
                            <tr>
                                <td class="labelCol vTop">Comments</td>
                                <td class="dataCol">
                                    <apex:form id="taskComments">
                                        <apex:outputPanel rendered="{!allowComments}">
                                            <apex:inputField styleClass="commentBody" value="{!comment.Body__c}" /><br/>
                                            <apex:commandLink onclick="if(!validateComment()){return false;}"
                                                oncomplete="Effect.Fade('sw_all')"
                                                action="{!saveComment}"                                     
                                                rerender="taskComments">
                                                <span>Save Comment</span>
                                            </apex:commandLink>
                                        </apex:outputPanel>
                                        <apex:repeat value="{!taskComments}" var="comment">
                                            <div class="taskComment">
                                                <span class="creator">
                                                    Created By <b>{!comment.createdBy.Name}</b>, {!comment.createdDate}
                                                </span>
                                                <div class="commentDelete">
                                                    <apex:commandLink oncomplete="Effect.Fade('sw_all')"
                                                        onclick="if(confirm('Are you sure you want to delete this comment?')){showSwirl();}else{return false;}"
                                                        value="Delete Comment" 
                                                        action="{!deleteComment}" 
                                                        rerender="taskComments">
                                                        <apex:param name="idComment" value="{!comment.Id}" />
                                                    </apex:commandLink>
                                                </div>
                                                <div>{!comment.Body__c}</div>
                                            </div>
                                        </apex:repeat>                          
                                    </apex:form>
                                </td>                               
                            </tr>
                        </tbody>                   
                    </table>
                     </apex:outputPanel>
                </div><br style="clear:both;" />               
            </apex:outputpanel>
            <br style="clear:both;" />
        </div>
        </div>
        
        <div align="center" class="breadCrumbAndButtons" style="padding-top:15px;">
            <div class="buttons" style="{!IF(Task.IsTaskOwner,'width:340px;','')}">
                <apex:outputpanel rendered="{!OR(userPermissions.canManage,Task.IsTaskOwner)}" layout="block">
                   <!--   <a class="blackbutton" href="/apex/projectRedirect?sO=ProjectTask__c&attr=task&page=ProjectCreateNewTask&rR=NewProjectFormContainer&oC=true&eid={!Task.ProjectId}&task={!Task.id}"><span>Edit Task</span></a>-->
                   <a class="blackbutton" href="/{!Task.id}/e?retURL=/{!Task.id}"><span>Edit Task</span></a>
                    <apex:form id="quickMilestoneForm2" styleclass="quickMilestoneForm" onsubmit="if(isCompleted){alert('The task percent is already completed.');return false}" >   
                        <apex:actionStatus id="taskStatus2">
                            <apex:facet name="start">
                                <a class="blackbutton" href="Javascript:;" ><span>Completing...</span></a>
                            </apex:facet>
                            <apex:facet name="stop">   
                                <apex:outputPanel id="TaskPanel2">       
                                    <apex:commandLink action="{!markComplete}"                                                                                 
                                        rerender="TaskPanel2, taskDetail"
                                        status="taskStatus2"
                                        rendered="{!IF(Task.PercentCompleted == 100 || isTaskParent, false, true)}"
                                        styleClass="blackbutton completeButton"
                                        oncomplete="completed(); apexAFRefreshDetail()">
                                        <span>Mark Complete</span>
                                    </apex:commandLink>
                                </apex:outputPanel>
                            </apex:facet>
                        </apex:actionStatus>
                    </apex:form>          
                    <a class="blackbutton" href="Javascript:;" onclick="showDeleteEvent('{!Task.id}', 'Detail','{!Task.name}');"><span>Delete</span></a>
                    <apex:outputPanel rendered="{!OR(userPermissions.canManage, Task.IsTaskOwner)}">
                        <a class="blackbutton" href="/apex/TaskPdfExport?id={!Task.id}">
                            <span>PDF Export</span>
                        </a>
                    </apex:outputPanel>            
                </apex:outputpanel>
            </div>
        </div>
    </div>
 <div id="modal_overlay5" style="position: fixed; top: 0pt; left: 0pt; width: 100%; height: 100%; z-index: 9998; display: none; background-color:black; opacity:0.6;"/>
    <script>        
         clearTableDetail();         
     </script>
     <script>
     function refreshAttachmentList(){
        refreshDetail();
     }
     
   
    
  
        
  
</script>

</apex:page>